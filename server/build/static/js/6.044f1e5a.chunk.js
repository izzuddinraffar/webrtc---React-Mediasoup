(this.webpackJsonpwebrtc_mediasoup=this.webpackJsonpwebrtc_mediasoup||[]).push([[6],{101:function(e,r,n){"use strict";n.d(r,"a",(function(){return t}));var t={SERVER_ENDPOINT:"localhost:5005",APP_ENDPOINT:"localhost:5001"}},105:function(e,r,n){"use strict";var t=n(3),c=n(0),o=n.n(c),a=n(51),s=n(101);r.a=function(e){return o.a.useEffect((function(){Object(a.io)(s.a.SERVER_ENDPOINT)}),[]),Object(t.jsx)("div",{className:"Layout",children:e.children})}},149:function(e,r,n){"use strict";n.r(r);var t=n(3),c=n(105),o=n(93),a=n.n(o);function s(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function u(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function i(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?u(Object(n),!0).forEach((function(r){s(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}var l=n(108),d=n(111),p=n(0),f=n.n(p),b=n(109),m=n(51),h=n(101),j="stream",g="share_screen",v=function(e){var r=f.a.useRef(),n=f.a.useState(!0),c=Object(d.a)(n,2),o=c[0],a=c[1],s=f.a.useState(!0),u=Object(d.a)(s,2),i=u[0],l=u[1],p=function(e,r){if(!e)return!1;e.getVideoTracks()[0].enabled=r,a(r)},b=function(e,r){if(!e)return!1;e.getAudioTracks()[0].enabled=r,l(r)};return f.a.useEffect((function(){var n;console.log("CreateRemoteVideos"),console.log(e),null===(n=e.playVideo(r.current,e.peer.stream))||void 0===n||n.then((function(){r.current.volume=1,console.log("remoteVideo.current"),console.log(r.current)})).catch((function(e){console.error("media ERROR:",e)}))}),[]),Object(t.jsxs)("div",{children:[Object(t.jsx)("div",{children:Object(t.jsx)("video",{ref:r,autoPlay:!0,style:{width:"360px",height:"240px",border:"1px solid black"}})}),e.mode==g?Object(t.jsxs)("div",{children:[o?Object(t.jsx)("button",{onClick:function(){return p(e.peer.stream,!1)},children:"Disable Video"}):Object(t.jsx)("button",{onClick:function(){return p(e.peer.stream,!0)},children:"Enable Video"}),i?Object(t.jsx)("button",{onClick:function(){return b(e.peer.stream,!1)},children:"Disable Audio"}):Object(t.jsx)("button",{onClick:function(){return b(e.peer.stream,!0)},children:"Enable Audio"})]}):null]})},O=f.a.memo(v);var k=function(e){var r=f.a.useRef(),n=f.a.useRef(),c=f.a.useRef(),o=f.a.useRef(),s=f.a.useRef(),u=f.a.useRef(),p=f.a.useRef(),v=f.a.useRef({}),k=f.a.useRef({}),x=f.a.useRef(),R=f.a.useRef({}),y=f.a.useRef({}),w=f.a.useRef({}),C=f.a.useRef(),P=f.a.useState(!0),I=Object(d.a)(P,2),A=I[0],T=I[1],E=f.a.useState(!0),S=Object(d.a)(E,2),N=S[0],D=S[1],V=f.a.useState(!1),_=Object(d.a)(V,2),W=_[0],M=_[1],L=f.a.useState(!1),U=Object(d.a)(L,2),Y=U[0],K=U[1],q=f.a.useState({}),J=Object(d.a)(q,2),H=J[0],z=J[1],B=f.a.useState(!1),F=Object(d.a)(B,2),G=F[0],Q=F[1],X=f.a.useState(""),Z=Object(d.a)(X,2),$=Z[0],ee=Z[1],re=f.a.useState(A),ne=Object(d.a)(re,2),te=ne[0],ce=ne[1],oe=f.a.useState(N),ae=Object(d.a)(oe,2),se=ae[0],ue=ae[1],ie=f.a.useState(A),le=Object(d.a)(ie,2),de=(le[0],le[1],f.a.useState(N)),pe=Object(d.a)(de,2),fe=(pe[0],pe[1],function(e,r){if(!e)return!1;e.getVideoTracks()[0].enabled=r,ce(r)}),be=function(e,r){if(!e)return!1;e.getAudioTracks()[0].enabled=r,ue(r)};function me(){return(me=Object(l.a)(a.a.mark((function e(){var r,t,c,o,s,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.current){e.next=3;break}return console.warn("WARN: local media NOT READY"),e.abrupt("return");case 3:return e.next=5,Ne("getRouterRtpCapabilities",{});case 5:return r=e.sent,console.log("getRouterRtpCapabilities:",r),e.next=9,Ee(r);case 9:return console.log("--- createProducerTransport --"),e.next=12,Ne("createProducerTransport",{mode:g});case 12:if(t=e.sent,console.log("transport params:",t),p.current=u.current.createSendTransport(t),console.log("createSendTransport:",p.current),p.current.on("connect",function(){var e=Object(l.a)(a.a.mark((function e(r,n,t){var c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--trasnport connect"),Ne("connectProducerTransport",{dtlsParameters:c}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),p.current.on("produce",function(){var e=Object(l.a)(a.a.mark((function e(r,n,t){var c,o,s,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.kind,o=r.rtpParameters,console.log("--trasnport produce"),e.prev=2,e.next=5,Ne("produce",{transportId:p.current.id,kind:c,rtpParameters:o,mode:g});case 5:s=e.sent,u=s.id,n({id:u}),console.log("--produce requested, then subscribe ---"),Ae(),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),t(e.t0);case 15:case"end":return e.stop()}}),e,null,[[2,12]])})));return function(r,n,t){return e.apply(this,arguments)}}()),p.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("publishing...");break;case"connected":console.log("published");break;case"failed":console.log("failed"),p.current.close()}})),!A){e.next=26;break}if(!(c=n.current.getVideoTracks()[0])){e.next=26;break}return o={track:c},e.next=25,p.current.produce(o);case 25:v.current.share_screen=e.sent;case 26:if(!N){e.next=33;break}if(!(s=n.current.getAudioTracks()[0])){e.next=33;break}return i={track:s},e.next=32,p.current.produce(i);case 32:k.current.share_screen=e.sent;case 33:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function he(){n.current&&(xe(r.current),Re(n.current),n.current=null,Q(!1))}function je(){return ge.apply(this,arguments)}function ge(){return(ge=Object(l.a)(a.a.mark((function e(){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return he(),null===(r=v.current.share_screen)||void 0===r||r.close(),delete v.current.share_screen,null===(n=k.current.share_screen)||void 0===n||n.close(),delete k.current.share_screen,e.next=9,Ne("producerStopShareScreen",{});case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ve(){o.current&&(xe(c.current),Re(o.current),o.current=null,M(!1))}function Oe(){for(var e in ve(),he(),v.current){var r=v.current[e];null===r||void 0===r||r.close(),delete v.current[e]}for(var n in k.current){var t=k.current[n];null===t||void 0===t||t.close(),delete k.current[n]}for(var c in p.current&&(p.current.close(),p.current=null),R.current)for(var o in R.current[c]){R.current[c][o].close(),delete R.current[c][o]}for(var a in y.current)for(var u in y.current[a]){y.current[a][u].close(),delete y.current[a][u]}w.current&&(w.current={}),x.current&&(x.current.close(),x.current=null),console.log(" ---- removeAllRemoteVideo() id"),w.current={},z((function(e){return i({},{})})),C.current&&(C.current.close(),C.current=null,s.current=null,console.log("socket.io closed..")),K(!1)}function ke(e,r){if(!e.srcObject)return e.srcObject=r,e.volume=0,e.play();console.warn("element ALREADY playing, so ignore")}function xe(e){e.pause(),e.srcObject=null}function Re(e){var r=e.getTracks();r?r.forEach((function(e){return e.stop()})):console.warn("NO tracks")}function ye(e,r,n){if(e===s.current)return!1;if(console.log("addremotetrack"),console.log(r),void 0==w.current[e]&&(w.current[e]={}),void 0==w.current[e][n]){var t=new MediaStream;t.addTrack(r),w.current[e][n]={stream:t,socket_id:e}}else w.current[e][n].stream.addTrack(r);z((function(e){return i({},w.current)}))}function we(e,r){console.log(" ---- removeRemoteVideo() id="+e),r==j?delete w.current[e]:delete w.current[e][r],z((function(r){return delete r[e],i({},w.current)}))}function Ce(e,r,n,t){return Pe.apply(this,arguments)}function Pe(){return(Pe=Object(l.a)(a.a.mark((function e(r,n,t,c){var o,s,i,l,d,p,f,b,m,h=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=h.length>4&&void 0!==h[4]?h[4]:j,console.log("--start of consumeAdd -- kind=%s",c),s=u.current.rtpCapabilities,e.next=5,Ne("consumeAdd",{rtpCapabilities:s,remoteId:n,kind:c,mode:o}).catch((function(e){console.error("consumeAdd ERROR:",e)}));case 5:return i=e.sent,l=i.producerId,d=i.id,p=i.kind,f=i.rtpParameters,t&&t!==l&&console.warn("producerID NOT MATCH"),b={},e.next=11,r.consume({id:d,producerId:l,kind:p,rtpParameters:f,codecOptions:b,mode:o});case 11:return m=e.sent,Me(n,m,p,o),m.remoteId=n,m.on("transportclose",(function(){console.log("--consumer transport closed. remoteId="+m.remoteId)})),m.on("producerclose",(function(){console.log("--consumer producer closed. remoteId="+m.remoteId),m.close(),We(m.remoteId,p,o),we(m.remoteId,o)})),m.on("trackended",(function(){console.log("--consumer trackended. remoteId="+m.remoteId)})),console.log("--end of consumeAdd"),"video"===p&&(console.log("--try resumeAdd --"),Ne("resumeAdd",{remoteId:n,kind:p,mode:o}).then((function(){console.log("resumeAdd OK")})).catch((function(e){console.error("resumeAdd ERROR:",e)}))),e.abrupt("return",new Promise((function(e,r){ye(n,m.track,o),e()})));case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ie(){return(Ie=Object(l.a)(a.a.mark((function e(){var r,n,t,c,s,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o.current){e.next=3;break}return console.warn("WARN: local media NOT READY"),e.abrupt("return");case 3:return e.next=5,Le().catch((function(e){console.error(e)}));case 5:return console.log("connected"),e.next=8,Ne("getRouterRtpCapabilities",{});case 8:return r=e.sent,console.log("getRouterRtpCapabilities:",r),e.next=12,Ee(r);case 12:return console.log("--- createProducerTransport --"),e.next=15,Ne("createProducerTransport",{mode:j});case 15:if(n=e.sent,console.log("transport params:",n),p.current=u.current.createSendTransport(n),console.log("createSendTransport:",p.current),p.current.on("connect",function(){var e=Object(l.a)(a.a.mark((function e(r,n,t){var c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--trasnport connect"),Ne("connectProducerTransport",{dtlsParameters:c}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),p.current.on("produce",function(){var e=Object(l.a)(a.a.mark((function e(r,n,t){var c,o,s,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.kind,o=r.rtpParameters,console.log("--trasnport produce"),e.prev=2,e.next=5,Ne("produce",{transportId:p.current.id,kind:c,rtpParameters:o,mode:j});case 5:s=e.sent,u=s.id,n({id:u}),console.log("--produce requested, then subscribe ---"),Ae(),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),t(e.t0);case 15:case"end":return e.stop()}}),e,null,[[2,12]])})));return function(r,n,t){return e.apply(this,arguments)}}()),p.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("publishing...");break;case"connected":console.log("published"),K(!0);break;case"failed":console.log("failed"),p.current.close()}})),!A){e.next=29;break}if(!(t=o.current.getVideoTracks()[0])){e.next=29;break}return c={track:t},e.next=28,p.current.produce(c);case 28:v.current.stream=e.sent;case 29:if(!N){e.next=36;break}if(!(s=o.current.getAudioTracks()[0])){e.next=36;break}return i={track:s},e.next=35,p.current.produce(i);case 35:k.current.stream=e.sent;case 36:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ae(){return Te.apply(this,arguments)}function Te(){return(Te=Object(l.a)(a.a.mark((function e(){var r,n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(C.current){e.next=3;break}return e.next=3,Le().catch((function(e){console.error(e)}));case 3:return e.next=5,Ne("getRouterRtpCapabilities",{});case 5:return r=e.sent,console.log("getRouterRtpCapabilities:",r),e.next=9,Ee(r);case 9:if(console.log("--- createConsumerTransport --"),x.current){e.next=20;break}return e.next=13,Ne("createConsumerTransport",{});case 13:n=e.sent,console.log("transport params:",n),x.current=u.current.createRecvTransport(n),console.log("createConsumerTransport:",x.current),x.current.on("connect",function(){var e=Object(l.a)(a.a.mark((function e(r,n,t){var c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--consumer trasnport connect"),Ne("connectConsumerTransport",{dtlsParameters:c}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),x.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("subscribing...");break;case"connected":console.log("subscribed");break;case"failed":console.log("failed"),p.current.close()}})),De(s.current);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ee(e){return Se.apply(this,arguments)}function Se(){return(Se=Object(l.a)(a.a.mark((function e(r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{u.current=new b.Device}catch(n){"UnsupportedError"===n.name&&console.error("browser not supported")}return e.next=3,u.current.load({routerRtpCapabilities:r});case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ne(e,r){return new Promise((function(n,t){C.current.emit(e,r,(function(e,r){e?t(e):n(r)}))}))}function De(e){return Ve.apply(this,arguments)}function Ve(){return(Ve=Object(l.a)(a.a.mark((function e(r){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("-- try consuleAll() --"),e.next=3,Ne("getCurrentProducers",{localId:r.current}).catch((function(e){console.error("getCurrentProducers ERROR:",e)}));case 3:n=e.sent,console.log("remoteInfo.remoteVideoIds:",n.remoteVideoIds),console.log("remoteInfo.remoteAudioIds:",n.remoteAudioIds),_e(x.current,n.remoteVideoIds,n.remoteAudioIds);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _e(e,r,n){console.log("----- consumeAll() -----"),r.forEach((function(r){Ce(e,r,null,"video",j).then((function(n){Ce(e,r,null,"video",g)}))}));n.forEach((function(r){Ce(e,r,null,"audio",j).then((function(n){Ce(e,r,null,"audio",g)}))}))}function We(e,r,n){if(void 0==n)return!1;"video"===r?(n==j?delete R.current[e]:delete R.current[e][n],console.log("videoConsumers count="+Object.keys(R.current).length)):"audio"===r?(n==j?delete y.current[e]:delete y.current[e][n],console.log("audioConsumers count="+Object.keys(y.current).length)):console.warn("UNKNOWN consumer kind="+r)}function Me(e,r,n,t){if(e===s.current)return!1;"video"===n?(void 0==R.current[e]&&(R.current[e]={}),R.current[e][t]=r,console.log("videoConsumers count="+Object.keys(R.current).length)):"audio"===n?(void 0==y.current[e]&&(y.current[e]={}),y.current[e][t]=r,console.log("audioConsumers count="+Object.keys(y.current).length)):console.warn("UNKNOWN consumer kind="+n)}var Le=function(){if(null==C.current){var e=Object(m.io)(h.a.SERVER_ENDPOINT+"/video-conference");C.current=e}return new Promise((function(e,r){var n=C.current;n.on("connect",function(){var e=Object(l.a)(a.a.mark((function e(r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("socket.io connected(). prepare room=%s",$),e.next=3,Ne("prepare_room",{roomId:$});case 3:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()),n.on("error",(function(e){console.error("socket.io ERROR:",e),r(e)})),n.on("message",(function(r){console.log("socket.io message:",r),"welcome"===r.type?(n.id!==r.id&&console.warn("WARN: something wrong with clientID",n.io,r.id),s.current=r.id,console.log("connected to server. clientId="+s.current),e()):console.error("UNKNOWN message from server:",r)})),n.on("newProducer",(function(e){console.log("socket.io newProducer:",e);var r=e.socketId,n=e.producerId,t=e.kind,c=e.mode;("video"===t||"audio"===t)&&(console.log("--try consumeAdd remoteId="+r+", prdId="+n+", kind="+t),Ce(x.current,r,n,t,c))})),n.on("producerClosed",(function(e){console.log("socket.io producerClosed:",e);var r=e.localId,n=e.remoteId,t=e.kind,c=e.mode;console.log("--try removeConsumer remoteId=%s, localId=%s, track=%s",n,r,t),We(n,t,c),we(n,c)}))}))};return f.a.useEffect((function(){return function(){Oe()}}),[]),Object(t.jsxs)("div",{children:[Object(t.jsxs)("div",{children:[Object(t.jsx)("input",{disabled:W,onChange:function(e){T(!A)},type:"checkbox",checked:A}),Object(t.jsx)("label",{children:"video"})]}),Object(t.jsxs)("div",{children:[Object(t.jsx)("input",{disabled:W,onChange:function(e){D(!N)},type:"checkbox",checked:N}),Object(t.jsx)("label",{children:"audio"})]}),W?Object(t.jsx)("button",{disabled:!W||Y,onClick:ve,children:"Stop Media"}):Object(t.jsx)("button",{disabled:W,onClick:function(){o.current?console.warn("WARN: local media ALREADY started"):navigator.mediaDevices.getUserMedia({audio:N,video:A}).then((function(e){o.current=e,ke(c.current,o.current),M(!0)})).catch((function(e){console.error("media ERROR:",e)}))},children:"Start Media"}),Object(t.jsx)("input",{type:"text",disabled:Y,onChange:function(e){ee(e.target.value)},value:$,placeholder:"room name"}),Y?Object(t.jsx)("button",{disabled:!Y||!W,onClick:Oe,children:"Disconnect"}):Object(t.jsx)("button",{disabled:Y||!W||0==$.trim().length,onClick:function(){return Ie.apply(this,arguments)},children:"Connect"}),G?Object(t.jsx)("button",{disabled:!W||!Y,onClick:je,children:"Stop Screen"}):Object(t.jsx)("button",{disabled:!W||!Y,onClick:function(){n.current?console.warn("WARN: local media ALREADY started"):navigator.mediaDevices.getDisplayMedia({audio:N,video:A}).then((function(e){n.current=e,ke(r.current,n.current),function(){me.apply(this,arguments)}(),Q(!0),e.getTracks()[0].onended=function(){je()}})).catch((function(e){console.error("media ERROR:",e)}))},children:"Start Screen"}),Object(t.jsxs)("div",{children:[Object(t.jsx)("div",{style:{marginTop:"20px"},children:"Local Video"}),Object(t.jsxs)("div",{style:{display:"flex",justifyContent:"center"},children:[Object(t.jsxs)("div",{children:[Object(t.jsx)("div",{children:Object(t.jsx)("video",{ref:c,autoPlay:!0,style:{width:"360px",height:"240px",border:"1px solid black"}})}),W?Object(t.jsxs)("div",{children:[te?Object(t.jsx)("button",{onClick:function(){return fe(o.current,!1)},children:"Disable Video"}):Object(t.jsx)("button",{onClick:function(){return fe(o.current,!0)},children:"Enable Video"}),se?Object(t.jsx)("button",{onClick:function(){return be(o.current,!1)},children:"Disable Audio"}):Object(t.jsx)("button",{onClick:function(){return be(o.current,!0)},children:"Enable Audio"})]}):null]}),Object(t.jsx)("div",{style:{display:G?"block":"none"},children:Object(t.jsx)("div",{children:Object(t.jsx)("video",{ref:r,autoPlay:!0,style:{width:"360px",height:"240px",border:"1px solid black"}})})})]})]}),Object(t.jsx)("div",{style:{marginTop:"20px"},children:"Remote Videos"}),Object(t.jsxs)("div",{style:{display:"flex",justifyContent:"center"},children:[console.log(H),Object.keys(H).map((function(e,r){return Object.keys(H[e]).map((function(r,n){var c=H[e][r];return Object(t.jsx)(O,{mode:r,peer:c,playVideo:ke},c.socket_id+"__"+r)}))}))]})]})};r.default=function(e){return e.match.params.view,Object(t.jsx)(c.a,{children:Object(t.jsx)(k,{})})}}}]);
//# sourceMappingURL=6.044f1e5a.chunk.js.map