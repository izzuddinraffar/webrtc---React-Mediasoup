(this.webpackJsonpwebrtc_mediasoup=this.webpackJsonpwebrtc_mediasoup||[]).push([[5],{101:function(e,r,n){"use strict";n.d(r,"a",(function(){return t}));var t={SERVER_ENDPOINT:"localhost:5005",APP_ENDPOINT:"localhost:5001"}},105:function(e,r,n){"use strict";var t=n(3),c=n(0),o=n.n(c),s=n(51),u=n(101);r.a=function(e){return o.a.useEffect((function(){Object(s.io)(u.a.SERVER_ENDPOINT)}),[]),Object(t.jsx)("div",{className:"Layout",children:e.children})}},150:function(e,r,n){"use strict";n.r(r);var t=n(3),c=n(105),o=n(93),s=n.n(o),u=n(108),a=n(111),i=n(0),l=n.n(i),d=n(109),p=n(51),f=n(101);var b=function(e){var r=l.a.useRef(),n=(l.a.useRef(),l.a.useRef()),c=l.a.useRef(),o=l.a.useRef(),i=l.a.useRef(),b=l.a.useRef(),h=l.a.useRef(),v=l.a.useState(!1),m=Object(a.a)(v,2),k=m[0],x=m[1],g=l.a.useState(!1),j=Object(a.a)(g,2);function O(e,n){var t=r.current;if(t.srcObject)t.srcObject.addTrack(n);else{var c=new MediaStream;c.addTrack(n),function(e,n){if(!e.srcObject)return e.srcObject=n,e.volume=0,r.current=e,console.log("playVideo"),console.log(r),e.play();console.warn("element ALREADY playing, so ignore")}(t,c).then((function(){t.volume=1})).catch((function(e){console.error("media ERROR:",e)}))}}function R(){return(R=Object(u.a)(s.a.mark((function e(){var r,n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,D().catch((function(e){console.error(e)}));case 2:return e.next=4,T("getRouterRtpCapabilities",{});case 4:return r=e.sent,console.log("getRouterRtpCapabilities:",r),e.next=8,E(r);case 8:return console.log("--- createConsumerTransport --"),e.next=11,T("createConsumerTransport",{});case 11:return n=e.sent,console.log("transport params:",n),o.current=c.current.createRecvTransport(n),console.log("createConsumerTransport:",o),o.current.on("connect",function(){var e=Object(u.a)(s.a.mark((function e(r,n,t){var c;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--consumer trasnport connect"),T("connectConsumerTransport",{dtlsParameters:c}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),o.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("subscribing...");break;case"connected":console.log("subscribed"),x(!0);break;case"failed":console.log("failed"),o.current.close()}})),e.next=19,w(o.current,"video");case 19:return i.current=e.sent,e.next=22,w(o.current,"audio");case 22:b.current=e.sent;case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function w(e,r){return y.apply(this,arguments)}function y(){return(y=Object(u.a)(s.a.mark((function e(r,n){var t;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N(r,n);case 2:if(!(t=e.sent)){e.next=8;break}console.log("-- track exist, consumer ready. kind="+n),"video"===n?(console.log("-- resume kind="+n),T("resume",{kind:n}).then((function(){return console.log("resume OK"),t})).catch((function(e){return console.error("resume ERROR:",e),t}))):console.log("-- do not resume kind="+n),e.next=10;break;case 8:return console.log("-- no consumer yet. kind="+n),e.abrupt("return",null);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function E(e){return P.apply(this,arguments)}function P(){return(P=Object(u.a)(s.a.mark((function e(r){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{c.current=new d.Device}catch(n){"UnsupportedError"===n.name&&console.error("browser not supported")}return e.next=3,c.current.load({routerRtpCapabilities:r});case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function N(e,r){return C.apply(this,arguments)}function C(){return(C=Object(u.a)(s.a.mark((function e(r,t){var o,u,a,i,l,d,p,f;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("--start of consume --kind="+t),o=c.current.rtpCapabilities,e.next=4,T("consume",{rtpCapabilities:o,kind:t}).catch((function(e){console.error("consume ERROR:",e)}));case 4:if(u=e.sent,a=u.producerId,i=u.id,l=u.kind,d=u.rtpParameters,!a){e.next=16;break}return p={},e.next=10,r.consume({id:i,producerId:a,kind:l,rtpParameters:d,codecOptions:p});case 10:return f=e.sent,O(n.current,f.track),console.log("--end of consume"),e.abrupt("return",f);case 16:return console.warn("--- remote producer NOT READY"),e.abrupt("return",null);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T(e,r){return new Promise((function(n,t){h.current.emit(e,r,(function(e,r){e?t(e):n(r)}))}))}j[0],j[1];var D=function(){if(null==h.current){var e=Object(p.io)(f.a.SERVER_ENDPOINT+"/video-broadcast");h.current=e}return new Promise((function(e,r){var t=h.current;t.on("connect",(function(e){console.log("socket.io connected()")})),t.on("error",(function(e){console.error("socket.io ERROR:",e),r(e)})),t.on("message",(function(r){console.log("socket.io message:",r),"welcome"===r.type?(t.id!==r.id&&console.warn("WARN: something wrong with clientID",t.io,r.id),n.current=r.id,console.log("connected to server. clientId="+n.current),e()):console.error("UNKNOWN message from server:",r)})),t.on("newProducer",function(){var e=Object(u.a)(s.a.mark((function e(r){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("socket.io newProducer:",r),!o.current){e.next=12;break}if("video"!==r.kind){e.next=8;break}return e.next=5,w(o.current,r.kind);case 5:i.current=e.sent,e.next=12;break;case 8:if("audio"!==r.kind){e.next=12;break}return e.next=11,w(o.current,r.kind);case 11:b.current=e.sent;case 12:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()),t.on("producerClosed",(function(e){console.log("socket.io producerClosed:",e);var r,n=e.localId,t=e.remoteId,c=e.kind;console.log("--try removeConsumer remoteId="+t+", localId="+n+", kind="+c),"video"===c?i.current&&(i.current.close(),i.current=null):"audio"===c&&b.current&&(b.current.close(),b.current=null),t?(r=t,console.log(" ---- removeRemoteVideo() id="+r)):I()}))}))};function I(){r.current&&(r.current.pause(),r.current.srcObject=null)}return Object(t.jsxs)("div",{children:[Object(t.jsx)("button",{disabled:k,onClick:function(){return R.apply(this,arguments)},children:"Subscribe"}),Object(t.jsx)("button",{disabled:!k,onClick:function(){i.current&&(i.current.close(),i.current=null),b.current&&(b.current.close(),b.current=null),o.current&&(o.current.close(),o.current=null),I(),h.current&&(h.current.close(),h.current=null,n.current=null,console.log("socket.io closed..")),x(!1)},children:"Disconnect"}),Object(t.jsxs)("div",{children:["remote video",Object(t.jsx)("br",{}),Object(t.jsx)("div",{children:Object(t.jsx)("video",{ref:r,autoPlay:!0,style:{width:"240px",height:"180px",border:"1px solid black"}})})]})]})};var h=function(e){var r=l.a.useRef(),n=l.a.useRef(),c=l.a.useRef(),o=l.a.useRef(),i=l.a.useRef(),b=l.a.useRef(),h=l.a.useRef(),v=l.a.useRef(),m=l.a.useState(!0),k=Object(a.a)(m,2),x=k[0],g=k[1],j=l.a.useState(!0),O=Object(a.a)(j,2),R=O[0],w=O[1],y=l.a.useState(!1),E=Object(a.a)(y,2),P=E[0],N=E[1],C=l.a.useState(!1),T=Object(a.a)(C,2),D=T[0],I=T[1];function S(e){e.pause(),e.srcObject=null}function A(e){var r=e.getTracks();r?r.forEach((function(e){return e.stop()})):console.warn("NO tracks")}function V(){return(V=Object(u.a)(s.a.mark((function e(){var r,t,c,a,l,d;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.current){e.next=3;break}return console.warn("WARN: local media NOT READY"),e.abrupt("return");case 3:if(v.current){e.next=6;break}return e.next=6,U().catch((function(e){console.error(e)}));case 6:return e.next=8,W("getRouterRtpCapabilities",{});case 8:return r=e.sent,console.log("getRouterRtpCapabilities:",r),e.next=12,_(r);case 12:return console.log("--- createProducerTransport --"),e.next=15,W("createProducerTransport",{});case 15:if(t=e.sent,console.log("transport params:",t),i.current=o.current.createSendTransport(t),console.log("createSendTransport:",i),i.current.on("connect",function(){var e=Object(u.a)(s.a.mark((function e(r,n,t){var c;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=r.dtlsParameters,console.log("--trasnport connect"),W("connectProducerTransport",{dtlsParameters:c}).then(n).catch(t);case 3:case"end":return e.stop()}}),e)})));return function(r,n,t){return e.apply(this,arguments)}}()),i.current.on("produce",function(){var e=Object(u.a)(s.a.mark((function e(r,n,t){var c,o,u,a;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=r.kind,o=r.rtpParameters,console.log("--trasnport produce"),e.prev=2,e.next=5,W("produce",{transportId:i.current.id,kind:c,rtpParameters:o});case 5:u=e.sent,a=u.id,n({id:a}),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),t(e.t0);case 13:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(r,n,t){return e.apply(this,arguments)}}()),i.current.on("connectionstatechange",(function(e){switch(e){case"connecting":console.log("publishing...");break;case"connected":console.log("published"),I(!0);break;case"failed":console.log("failed"),i.current.close()}})),!x){e.next=29;break}if(!(c=n.current.getVideoTracks()[0])){e.next=29;break}return a={track:c},e.next=28,i.current.produce(a);case 28:b.current=e.sent;case 29:if(!R){e.next=36;break}if(!(l=n.current.getAudioTracks()[0])){e.next=36;break}return d={track:l},e.next=35,i.current.produce(d);case 35:h.current=e.sent;case 36:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var _=function(){var e=Object(u.a)(s.a.mark((function e(r){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{o.current=new d.Device,console.log("device.current"),console.log(o.current)}catch(n){"UnsupportedError"===n.name&&console.error("browser not supported")}return console.log("device.current start"),console.log(o.current),console.log("device.current end"),e.next=6,o.current.load({routerRtpCapabilities:r});case 6:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}();function W(e,r){return new Promise((function(n,t){v.current.emit(e,r,(function(e,r){e?t(e):n(r)}))}))}var U=function(){if(null==v.current){var e=Object(p.io)(f.a.SERVER_ENDPOINT+"/video-broadcast");v.current=e}return new Promise((function(e,r){var n=v.current;n.on("connect",(function(e){console.log("socket.io connected()")})),n.on("error",(function(e){console.error("socket.io ERROR:",e),r(e)})),n.on("message",(function(r){console.log("socket.io message:",r),"welcome"===r.type?(n.id!==r.id&&console.warn("WARN: something wrong with clientID",n.io,r.id),c.current=r.id,console.log("connected to server. clientId="+c.current),e()):console.error("UNKNOWN message from server:",r)})),n.on("newProducer",function(){var e=Object(u.a)(s.a.mark((function e(r){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.warn("IGNORE socket.io newProducer:",r);case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}())}))};return Object(t.jsxs)("div",{children:[Object(t.jsxs)("div",{children:[Object(t.jsx)("input",{disabled:P,onChange:function(e){g(!x)},type:"checkbox",checked:x}),Object(t.jsx)("label",{children:"video"})]}),Object(t.jsxs)("div",{children:[Object(t.jsx)("input",{disabled:P,onChange:function(e){w(!R)},type:"checkbox",checked:R}),Object(t.jsx)("label",{children:"audio"})]}),Object(t.jsx)("button",{disabled:P,onClick:function(){n.current?console.warn("WARN: local media ALREADY started"):navigator.mediaDevices.getUserMedia({audio:R,video:x}).then((function(e){n.current=e,function(e,r){if(e.srcObject)return void console.warn("element ALREADY playing, so ignore");e.srcObject=r,e.volume=0,e.play()}(r.current,n.current),N(!0)})).catch((function(e){console.error("media ERROR:",e)}))},children:"Start Media"}),Object(t.jsx)("button",{disabled:!P||D,onClick:function(){n.current&&(S(r.current),A(n.current),n.current=null,N(!1))},children:"Stop Media"}),Object(t.jsx)("button",{disabled:D||!P,onClick:function(){return V.apply(this,arguments)},children:"publish"}),Object(t.jsx)("button",{disabled:!D||!P,onClick:function(){n.current&&(S(r.current),A(n.current),n.current=null),b.current&&(b.current.close(),b.current=null),h.current&&(h.current.close(),h.current=null),i.current&&(i.current.close(),i.current=null),v.current&&(v.current.close(),v.current=null,c.current=null,console.log("socket.io closed..")),I(!1),N(!1)},children:"Disconnect"}),Object(t.jsxs)("div",{children:["local video",Object(t.jsx)("video",{ref:r,autoPlay:!0,style:{width:"240px",height:"180px",border:"1px solid black"}})]})]})};r.default=function(e){var r=e.match.params.view;return Object(t.jsxs)(c.a,{children:["publish"===r?Object(t.jsx)(h,{}):null,"subscribe"===r?Object(t.jsx)(b,{}):null]})}}}]);
//# sourceMappingURL=5.ba8a3b80.chunk.js.map